import { merge, Subject } from 'rxjs';
import { coerceArray, get, resolveParams } from './utils';
import { auditTime, map, takeUntil } from 'rxjs/operators';
import { QueryParamDef } from './QueryParamDef';
import set from 'lodash.set';
export class BindQueryParamsManager {
    constructor(router, defs, options, createOptions) {
        this.router = router;
        this.options = options;
        this.createOptions = createOptions;
        this.$destroy = new Subject();
        this.defsSynced = {};
        this.defs = coerceArray(defs).map((def) => new QueryParamDef(def));
    }
    connect(group) {
        this.group = group;
        this.onInit();
        return this;
    }
    onInit() {
        this.handleInitialURLSync();
        this.updateControl(this.defs, { emitEvent: true }, (def) => !!(def.syncInitialQueryParamValue ?? this.createOptions?.syncInitialQueryParamValue));
        const controls = this.defs.map((def) => {
            return this.group.get(def.path).valueChanges.pipe(map((value) => ({
                def,
                value,
            })));
        });
        // Could be a several changes in the same tick,
        // for example when we use reset() or patchValue.
        // We need to aggregate the changes and apply them once
        // because the router navigates in micro task
        let buffer = [];
        merge(...controls)
            .pipe(map((result) => buffer.push(result)), auditTime(0), takeUntil(this.$destroy))
            .subscribe(() => {
            this.updateQueryParams(resolveParams(buffer));
            buffer = [];
        });
    }
    destroy() {
        this.$destroy.next();
    }
    getDef(queryKey) {
        return this.defs.find((def) => def.queryKey === queryKey);
    }
    parse(queryParams) {
        const result = {};
        for (const [key, value] of Object.entries(queryParams)) {
            const def = this.getDef(key);
            if (def) {
                result[key] = def.parse(value);
            }
        }
        return result;
    }
    syncAllDefs(options = { emitEvent: true }) {
        const allKeys = this.defs.map((def) => def.queryKey);
        this.syncDefs(allKeys, options);
    }
    syncDefs(queryKeys, options = { emitEvent: true }) {
        const defs = [];
        coerceArray(queryKeys).forEach((key) => {
            if (!this.defsSynced[key]) {
                this.defsSynced[key] = true;
                const def = this.getDef(key);
                if (def) {
                    defs.push(def);
                }
            }
        });
        if (defs.length) {
            this.updateControl(defs, options);
        }
    }
    paramExists(queryKey) {
        return this.search.has(queryKey);
    }
    someParamExists() {
        return this.defs.some((def) => {
            return this.search.has(def.queryKey);
        });
    }
    get search() {
        return new URLSearchParams(this.options.windowRef.location.search);
    }
    handleInitialURLSync() {
        const initialSyncDefs = [];
        for (const def of this.defs) {
            const syncInitialControlValue = def.syncInitialControlValue ?? this.createOptions?.syncInitialControlValue;
            if (syncInitialControlValue && !this.paramExists(def.queryKey)) {
                initialSyncDefs.push({ def, value: get(this.group.value, def.path) });
            }
        }
        if (initialSyncDefs.length) {
            this.updateQueryParams({
                // The router doesn't know the current query params so
                // we need to add it manually
                ...Object.fromEntries(this.search),
                ...resolveParams(initialSyncDefs),
            });
        }
    }
    updateQueryParams(queryParams) {
        this.router.navigate([], {
            queryParams,
            queryParamsHandling: 'merge',
            replaceUrl: true,
        });
    }
    updateControl(defs, options, updatePredicate = (_) => true) {
        const queryParams = new URLSearchParams(this.options.windowRef.location.search);
        let value = {};
        for (const def of defs) {
            if (updatePredicate(def)) {
                const { queryKey } = def;
                const queryParamValue = queryParams.get(queryKey);
                if (!queryParamValue)
                    continue;
                set(value, def.path.split('.'), def.parse(queryParamValue));
            }
        }
        if (Object.keys(value).length) {
            this.group.patchValue(value, options);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmluZFF1ZXJ5UGFyYW1zTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nbmVhdC9iaW5kLXF1ZXJ5LXBhcmFtcy9zcmMvbGliL0JpbmRRdWVyeVBhcmFtc01hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFdEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxHQUFHLEVBQUUsYUFBYSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzFELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNoRCxPQUFPLEdBQUcsTUFBTSxZQUFZLENBQUM7QUFFN0IsTUFBTSxPQUFPLHNCQUFzQjtJQVlqQyxZQUNVLE1BQWMsRUFDdEIsSUFBK0MsRUFDdkMsT0FBK0IsRUFDL0IsYUFBK0Y7UUFIL0YsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUVkLFlBQU8sR0FBUCxPQUFPLENBQXdCO1FBQy9CLGtCQUFhLEdBQWIsYUFBYSxDQUFrRjtRQWJqRyxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUN6QixlQUFVLEdBQTZCLEVBQThCLENBQUM7UUFjNUUsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFiRCxPQUFPLENBQUMsS0FBZ0I7UUFDdEIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBV0QsTUFBTTtRQUNKLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBRTVCLElBQUksQ0FBQyxhQUFhLENBQ2hCLElBQUksQ0FBQyxJQUFJLEVBQ1QsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEVBQ25CLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsMEJBQTBCLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSwwQkFBMEIsQ0FBQyxDQUM5RixDQUFDO1FBRUYsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNyQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUNoRCxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBQ2QsR0FBRztnQkFDSCxLQUFLO2FBQ04sQ0FBQyxDQUFDLENBQ0osQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUgsK0NBQStDO1FBQy9DLGlEQUFpRDtRQUNqRCx1REFBdUQ7UUFDdkQsNkNBQTZDO1FBQzdDLElBQUksTUFBTSxHQUEwQixFQUFFLENBQUM7UUFFdkMsS0FBSyxDQUFDLEdBQUcsUUFBUSxDQUFDO2FBQ2YsSUFBSSxDQUNILEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUNwQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQ1osU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FDekI7YUFDQSxTQUFTLENBQUMsR0FBRyxFQUFFO1lBQ2QsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQzlDLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDZCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxPQUFPO1FBQ0wsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRUQsTUFBTSxDQUFDLFFBQWlCO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUF1QjtRQUMzQixNQUFNLE1BQU0sR0FBNEIsRUFBRSxDQUFDO1FBRTNDLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQ3RELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBYyxDQUFDLENBQUM7WUFFeEMsSUFBSSxHQUFHLEVBQUU7Z0JBQ1AsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBZSxDQUFDLENBQUM7YUFDMUM7U0FDRjtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxXQUFXLENBQUMsVUFBMkIsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFO1FBQ3hELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDckQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELFFBQVEsQ0FBQyxTQUFvRCxFQUFFLFVBQTJCLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRTtRQUMzRyxNQUFNLElBQUksR0FBdUIsRUFBRSxDQUFDO1FBRXBDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDekIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7Z0JBQzVCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBYyxDQUFDLENBQUM7Z0JBRXhDLElBQUksR0FBRyxFQUFFO29CQUNQLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2hCO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNmLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ25DO0lBQ0gsQ0FBQztJQUVELFdBQVcsQ0FBQyxRQUFpQjtRQUMzQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQWtCLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsZUFBZTtRQUNiLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUM1QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN2QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLE1BQU07UUFDUixPQUFPLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRU8sb0JBQW9CO1FBQzFCLE1BQU0sZUFBZSxHQUF3QyxFQUFFLENBQUM7UUFFaEUsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQzNCLE1BQU0sdUJBQXVCLEdBQUcsR0FBRyxDQUFDLHVCQUF1QixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUUsdUJBQXVCLENBQUM7WUFFM0csSUFBSSx1QkFBdUIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUM5RCxlQUFlLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUN2RTtTQUNGO1FBRUQsSUFBSSxlQUFlLENBQUMsTUFBTSxFQUFFO1lBQzFCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztnQkFDckIsc0RBQXNEO2dCQUN0RCw2QkFBNkI7Z0JBQzdCLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBYSxDQUFDO2dCQUN6QyxHQUFHLGFBQWEsQ0FBQyxlQUFlLENBQUM7YUFDbEMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBRU8saUJBQWlCLENBQUMsV0FBbUI7UUFDM0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFO1lBQ3ZCLFdBQVc7WUFDWCxtQkFBbUIsRUFBRSxPQUFPO1lBQzVCLFVBQVUsRUFBRSxJQUFJO1NBQ2pCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxhQUFhLENBQ25CLElBQXFCLEVBQ3JCLE9BQStCLEVBQy9CLGtCQUFrQixDQUFDLENBQWdCLEVBQUUsRUFBRSxDQUFDLElBQUk7UUFFNUMsTUFBTSxXQUFXLEdBQUcsSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2hGLElBQUksS0FBSyxHQUFlLEVBQUUsQ0FBQztRQUUzQixLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksRUFBRTtZQUN0QixJQUFJLGVBQWUsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDeEIsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLEdBQUcsQ0FBQztnQkFDekIsTUFBTSxlQUFlLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFFbEQsSUFBSSxDQUFDLGVBQWU7b0JBQUUsU0FBUztnQkFFL0IsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7YUFDN0Q7U0FDRjtRQUVELElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEVBQUU7WUFDN0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ3ZDO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgbWVyZ2UsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBjb2VyY2VBcnJheSwgZ2V0LCByZXNvbHZlUGFyYW1zIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBhdWRpdFRpbWUsIG1hcCwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQmluZFF1ZXJ5UGFyYW1zT3B0aW9ucywgUXVlcnlEZWZPcHRpb25zLCBSZXNvbHZlUGFyYW1zT3B0aW9uLCBTeW5jRGVmc09wdGlvbnMgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IFF1ZXJ5UGFyYW1EZWYgfSBmcm9tICcuL1F1ZXJ5UGFyYW1EZWYnO1xuaW1wb3J0IHNldCBmcm9tICdsb2Rhc2guc2V0JztcblxuZXhwb3J0IGNsYXNzIEJpbmRRdWVyeVBhcmFtc01hbmFnZXI8VCA9IGFueT4ge1xuICBwcml2YXRlIGRlZnM6IFF1ZXJ5UGFyYW1EZWY8VD5bXTtcbiAgcHJpdmF0ZSBncm91cCE6IEZvcm1Hcm91cDtcbiAgcHJpdmF0ZSAkZGVzdHJveSA9IG5ldyBTdWJqZWN0KCk7XG4gIHByaXZhdGUgZGVmc1N5bmNlZDogUmVjb3JkPGtleW9mIFQsIGJvb2xlYW4+ID0ge30gYXMgUmVjb3JkPGtleW9mIFQsIGJvb2xlYW4+O1xuXG4gIGNvbm5lY3QoZ3JvdXA6IEZvcm1Hcm91cCkge1xuICAgIHRoaXMuZ3JvdXAgPSBncm91cDtcbiAgICB0aGlzLm9uSW5pdCgpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBkZWZzOiBRdWVyeURlZk9wdGlvbnM8VD5bXSB8IFF1ZXJ5RGVmT3B0aW9uczxUPixcbiAgICBwcml2YXRlIG9wdGlvbnM6IEJpbmRRdWVyeVBhcmFtc09wdGlvbnMsXG4gICAgcHJpdmF0ZSBjcmVhdGVPcHRpb25zPzogUGljazxRdWVyeURlZk9wdGlvbnMsICdzeW5jSW5pdGlhbENvbnRyb2xWYWx1ZScgfCAnc3luY0luaXRpYWxRdWVyeVBhcmFtVmFsdWUnPlxuICApIHtcbiAgICB0aGlzLmRlZnMgPSBjb2VyY2VBcnJheShkZWZzKS5tYXAoKGRlZikgPT4gbmV3IFF1ZXJ5UGFyYW1EZWYoZGVmKSk7XG4gIH1cblxuICBvbkluaXQoKSB7XG4gICAgdGhpcy5oYW5kbGVJbml0aWFsVVJMU3luYygpO1xuXG4gICAgdGhpcy51cGRhdGVDb250cm9sKFxuICAgICAgdGhpcy5kZWZzLFxuICAgICAgeyBlbWl0RXZlbnQ6IHRydWUgfSxcbiAgICAgIChkZWYpID0+ICEhKGRlZi5zeW5jSW5pdGlhbFF1ZXJ5UGFyYW1WYWx1ZSA/PyB0aGlzLmNyZWF0ZU9wdGlvbnM/LnN5bmNJbml0aWFsUXVlcnlQYXJhbVZhbHVlKVxuICAgICk7XG5cbiAgICBjb25zdCBjb250cm9scyA9IHRoaXMuZGVmcy5tYXAoKGRlZikgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuZ3JvdXAuZ2V0KGRlZi5wYXRoKSEudmFsdWVDaGFuZ2VzLnBpcGUoXG4gICAgICAgIG1hcCgodmFsdWUpID0+ICh7XG4gICAgICAgICAgZGVmLFxuICAgICAgICAgIHZhbHVlLFxuICAgICAgICB9KSlcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICAvLyBDb3VsZCBiZSBhIHNldmVyYWwgY2hhbmdlcyBpbiB0aGUgc2FtZSB0aWNrLFxuICAgIC8vIGZvciBleGFtcGxlIHdoZW4gd2UgdXNlIHJlc2V0KCkgb3IgcGF0Y2hWYWx1ZS5cbiAgICAvLyBXZSBuZWVkIHRvIGFnZ3JlZ2F0ZSB0aGUgY2hhbmdlcyBhbmQgYXBwbHkgdGhlbSBvbmNlXG4gICAgLy8gYmVjYXVzZSB0aGUgcm91dGVyIG5hdmlnYXRlcyBpbiBtaWNybyB0YXNrXG4gICAgbGV0IGJ1ZmZlcjogUmVzb2x2ZVBhcmFtc09wdGlvbltdID0gW107XG5cbiAgICBtZXJnZSguLi5jb250cm9scylcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKHJlc3VsdCkgPT4gYnVmZmVyLnB1c2gocmVzdWx0KSksXG4gICAgICAgIGF1ZGl0VGltZSgwKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuJGRlc3Ryb3kpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgdGhpcy51cGRhdGVRdWVyeVBhcmFtcyhyZXNvbHZlUGFyYW1zKGJ1ZmZlcikpO1xuICAgICAgICBidWZmZXIgPSBbXTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICB0aGlzLiRkZXN0cm95Lm5leHQoKTtcbiAgfVxuXG4gIGdldERlZihxdWVyeUtleToga2V5b2YgVCkge1xuICAgIHJldHVybiB0aGlzLmRlZnMuZmluZCgoZGVmKSA9PiBkZWYucXVlcnlLZXkgPT09IHF1ZXJ5S2V5KTtcbiAgfVxuXG4gIHBhcnNlKHF1ZXJ5UGFyYW1zOiBQYXJ0aWFsPFQ+KSB7XG4gICAgY29uc3QgcmVzdWx0OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiA9IHt9O1xuXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMocXVlcnlQYXJhbXMpKSB7XG4gICAgICBjb25zdCBkZWYgPSB0aGlzLmdldERlZihrZXkgYXMga2V5b2YgVCk7XG5cbiAgICAgIGlmIChkZWYpIHtcbiAgICAgICAgcmVzdWx0W2tleV0gPSBkZWYucGFyc2UodmFsdWUgYXMgc3RyaW5nKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgc3luY0FsbERlZnMob3B0aW9uczogU3luY0RlZnNPcHRpb25zID0geyBlbWl0RXZlbnQ6IHRydWUgfSkge1xuICAgIGNvbnN0IGFsbEtleXMgPSB0aGlzLmRlZnMubWFwKChkZWYpID0+IGRlZi5xdWVyeUtleSk7XG4gICAgdGhpcy5zeW5jRGVmcyhhbGxLZXlzLCBvcHRpb25zKTtcbiAgfVxuXG4gIHN5bmNEZWZzKHF1ZXJ5S2V5czogKGtleW9mIFQgJiBzdHJpbmcpIHwgKGtleW9mIFQgJiBzdHJpbmcpW10sIG9wdGlvbnM6IFN5bmNEZWZzT3B0aW9ucyA9IHsgZW1pdEV2ZW50OiB0cnVlIH0pIHtcbiAgICBjb25zdCBkZWZzOiBRdWVyeVBhcmFtRGVmPFQ+W10gPSBbXTtcblxuICAgIGNvZXJjZUFycmF5KHF1ZXJ5S2V5cykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICBpZiAoIXRoaXMuZGVmc1N5bmNlZFtrZXldKSB7XG4gICAgICAgIHRoaXMuZGVmc1N5bmNlZFtrZXldID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgZGVmID0gdGhpcy5nZXREZWYoa2V5IGFzIGtleW9mIFQpO1xuXG4gICAgICAgIGlmIChkZWYpIHtcbiAgICAgICAgICBkZWZzLnB1c2goZGVmKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKGRlZnMubGVuZ3RoKSB7XG4gICAgICB0aGlzLnVwZGF0ZUNvbnRyb2woZGVmcywgb3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgcGFyYW1FeGlzdHMocXVlcnlLZXk6IGtleW9mIFQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zZWFyY2guaGFzKHF1ZXJ5S2V5IGFzIHN0cmluZyk7XG4gIH1cblxuICBzb21lUGFyYW1FeGlzdHMoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZGVmcy5zb21lKChkZWYpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnNlYXJjaC5oYXMoZGVmLnF1ZXJ5S2V5KTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldCBzZWFyY2goKSB7XG4gICAgcmV0dXJuIG5ldyBVUkxTZWFyY2hQYXJhbXModGhpcy5vcHRpb25zLndpbmRvd1JlZi5sb2NhdGlvbi5zZWFyY2gpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVJbml0aWFsVVJMU3luYygpIHtcbiAgICBjb25zdCBpbml0aWFsU3luY0RlZnM6IFBhcmFtZXRlcnM8dHlwZW9mIHJlc29sdmVQYXJhbXM+WzBdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IGRlZiBvZiB0aGlzLmRlZnMpIHtcbiAgICAgIGNvbnN0IHN5bmNJbml0aWFsQ29udHJvbFZhbHVlID0gZGVmLnN5bmNJbml0aWFsQ29udHJvbFZhbHVlID8/IHRoaXMuY3JlYXRlT3B0aW9ucz8uc3luY0luaXRpYWxDb250cm9sVmFsdWU7XG5cbiAgICAgIGlmIChzeW5jSW5pdGlhbENvbnRyb2xWYWx1ZSAmJiAhdGhpcy5wYXJhbUV4aXN0cyhkZWYucXVlcnlLZXkpKSB7XG4gICAgICAgIGluaXRpYWxTeW5jRGVmcy5wdXNoKHsgZGVmLCB2YWx1ZTogZ2V0KHRoaXMuZ3JvdXAudmFsdWUsIGRlZi5wYXRoKSB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoaW5pdGlhbFN5bmNEZWZzLmxlbmd0aCkge1xuICAgICAgdGhpcy51cGRhdGVRdWVyeVBhcmFtcyh7XG4gICAgICAgIC8vIFRoZSByb3V0ZXIgZG9lc24ndCBrbm93IHRoZSBjdXJyZW50IHF1ZXJ5IHBhcmFtcyBzb1xuICAgICAgICAvLyB3ZSBuZWVkIHRvIGFkZCBpdCBtYW51YWxseVxuICAgICAgICAuLi5PYmplY3QuZnJvbUVudHJpZXModGhpcy5zZWFyY2ggYXMgYW55KSxcbiAgICAgICAgLi4ucmVzb2x2ZVBhcmFtcyhpbml0aWFsU3luY0RlZnMpLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVRdWVyeVBhcmFtcyhxdWVyeVBhcmFtczogb2JqZWN0KSB7XG4gICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW10sIHtcbiAgICAgIHF1ZXJ5UGFyYW1zLFxuICAgICAgcXVlcnlQYXJhbXNIYW5kbGluZzogJ21lcmdlJyxcbiAgICAgIHJlcGxhY2VVcmw6IHRydWUsXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUNvbnRyb2woXG4gICAgZGVmczogUXVlcnlQYXJhbURlZltdLFxuICAgIG9wdGlvbnM6IHsgZW1pdEV2ZW50OiBib29sZWFuIH0sXG4gICAgdXBkYXRlUHJlZGljYXRlID0gKF86IFF1ZXJ5UGFyYW1EZWYpID0+IHRydWVcbiAgKSB7XG4gICAgY29uc3QgcXVlcnlQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHRoaXMub3B0aW9ucy53aW5kb3dSZWYubG9jYXRpb24uc2VhcmNoKTtcbiAgICBsZXQgdmFsdWU6IFBhcnRpYWw8VD4gPSB7fTtcblxuICAgIGZvciAoY29uc3QgZGVmIG9mIGRlZnMpIHtcbiAgICAgIGlmICh1cGRhdGVQcmVkaWNhdGUoZGVmKSkge1xuICAgICAgICBjb25zdCB7IHF1ZXJ5S2V5IH0gPSBkZWY7XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1WYWx1ZSA9IHF1ZXJ5UGFyYW1zLmdldChxdWVyeUtleSk7XG5cbiAgICAgICAgaWYgKCFxdWVyeVBhcmFtVmFsdWUpIGNvbnRpbnVlO1xuXG4gICAgICAgIHNldCh2YWx1ZSwgZGVmLnBhdGguc3BsaXQoJy4nKSwgZGVmLnBhcnNlKHF1ZXJ5UGFyYW1WYWx1ZSkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChPYmplY3Qua2V5cyh2YWx1ZSkubGVuZ3RoKSB7XG4gICAgICB0aGlzLmdyb3VwLnBhdGNoVmFsdWUodmFsdWUsIG9wdGlvbnMpO1xuICAgIH1cbiAgfVxufVxuIl19